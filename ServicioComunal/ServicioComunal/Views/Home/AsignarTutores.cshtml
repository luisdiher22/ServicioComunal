@model IEnumerable<ServicioComunal.Models.Profesor>
@{
    ViewData["Title"] = "Asignar Tutores";
    Layout = "_Layout";
}

<div class="dashboard-content">
    <div class="content-header">
        <div class="header-left">
            <h1>Asignar Tutores</h1>
            <p>Gestionar asignación de tutores a grupos</p>
        </div>
        <div class="header-actions">
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalImportar">
                <i class="fas fa-file-excel"></i>
                Importar Profesores
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalTutor">
                <i class="fas fa-plus"></i>
                Agregar Docente
            </button>
        </div>
    </div>

    <!-- Filtros y búsqueda -->
    <div class="filters-section">
        <div class="filters-card">
            <div class="row">
                <div class="col-md-4">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Buscar por nombre, apellidos o cédula..." class="form-control">
                    </div>
                </div>
                <div class="col-md-3">
                    <select id="filterRol" class="form-select">
                        <option value="">Todos los roles</option>
                        <option value="Tutor">Tutor</option>
                        <option value="Administrador">Administrador</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="filterDisponibilidad" class="form-select">
                        <option value="">Cualquier estado</option>
                        <option value="disponible">Disponible</option>
                        <option value="asignado">Con grupos asignados</option>
                        <option value="completo">Capacidad completa</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()">
                        <i class="fas fa-times"></i>
                        Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-icon tutors">
                <i class="fas fa-chalkboard-teacher"></i>
            </div>
            <div class="stat-info">
                <div class="stat-number" id="totalTutores">@Model.Count()</div>
                <div class="stat-label">Total Tutores</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon groups">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
                <div class="stat-number" id="conGrupos">@Model.Count(t => t.GruposProfesores.Any())</div>
                <div class="stat-label">Con Grupos</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <div class="stat-number" id="disponibles">@Model.Count(t => !t.GruposProfesores.Any())</div>
                <div class="stat-label">Disponibles</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon progress">
                <i class="fas fa-chart-pie"></i>
            </div>
            <div class="stat-info">
                <div class="stat-number" id="promedio">@(Model.Any() ? Math.Round(Model.Average(t => t.GruposProfesores.Count), 1) : 0)</div>
                <div class="stat-label">Grupos por Tutor</div>
            </div>
        </div>
    </div>

    <!-- Tabla de tutores -->
    <div class="table-section">
        <div class="table-card">
            <div class="table-header">
                <h3>Lista de Tutores</h3>
                <div class="table-actions">
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="asignacionAutomatica()">
                        <i class="fas fa-magic"></i>
                        Asignación Automática
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download"></i>
                        Exportar
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover" id="tablaTutores">
                    <thead>
                        <tr>
                            <th>Tutor</th>
                            <th>Rol</th>
                            <th>Grupos Asignados</th>
                            <th>Disponibilidad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var tutor in Model)
                        {
                            var gruposAsignados = tutor.GruposProfesores.Count();
                            var maxGrupos = 3; // Límite máximo de grupos por tutor
                            <tr data-tutor-id="@tutor.Identificacion">
                                <td>
                                    <div class="tutor-info">
                                        <div class="tutor-avatar">
                                            <i class="fas fa-user-tie"></i>
                                        </div>
                                        <div class="tutor-details">
                                            <strong>@tutor.Nombre @tutor.Apellidos</strong>
                                            <small class="text-muted d-block">Cédula: @tutor.Identificacion</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @if (tutor.Rol == "Administrador")
                                    {
                                        <span class="badge-rol administrador">
                                            <i class="fas fa-crown"></i> @tutor.Rol
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge-rol @tutor.Rol.ToLower()">@tutor.Rol</span>
                                    }
                                </td>
                                <td>
                                    <div class="grupos-asignados">
                                        <span class="grupos-count">@gruposAsignados grupos</span>
                                        @if (gruposAsignados > 0)
                                        {
                                            <div class="grupos-list">
                                                @foreach (var grupo in tutor.GruposProfesores.Take(3))
                                                {
                                                    <span class="grupo-tag">Grupo @grupo.GrupoNumero</span>
                                                }
                                                @if (gruposAsignados > 3)
                                                {
                                                    <span class="grupo-tag more">+@(gruposAsignados - 3)</span>
                                                }
                                            </div>
                                        }
                                        <div class="progress-bar-small">
                                            <div class="progress-fill" style="width: @(Math.Min(100, (gruposAsignados * 100.0 / maxGrupos)))%"></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @if (gruposAsignados == 0)
                                    {
                                        <span class="badge badge-success">
                                            <i class="fas fa-check-circle"></i>
                                            Disponible
                                        </span>
                                    }
                                    else if (gruposAsignados < maxGrupos)
                                    {
                                        <span class="badge badge-warning">
                                            <i class="fas fa-clock"></i>
                                            Parcialmente asignado
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-danger">
                                            <i class="fas fa-times-circle"></i>
                                            Capacidad completa
                                        </span>
                                    }
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="verTutor(@tutor.Identificacion)" 
                                                title="Ver detalles">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" 
                                                onclick="asignarGrupos(@tutor.Identificacion)" 
                                                title="Asignar grupos">
                                            <i class="fas fa-users-cog"></i>
                                        </button>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" 
                                                    data-bs-toggle="dropdown" aria-expanded="false" title="Cambiar rol">
                                                <i class="fas fa-user-tag"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="cambiarRol(@tutor.Identificacion, 'Tutor')">Tutor</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item" href="#" onclick="cambiarRol(@tutor.Identificacion, 'Administrador')">
                                                    <i class="fas fa-crown text-warning"></i> Administrador
                                                </a></li>
                                            </ul>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-warning" 
                                                onclick="editarTutor(@tutor.Identificacion)" 
                                                title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="eliminarTutor(@tutor.Identificacion)" 
                                                title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar/Editar Tutor -->
<div class="modal fade" id="modalTutor" tabindex="-1" aria-labelledby="modalTutorLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTutorLabel">Agregar Docente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formTutor" novalidate>
                    <input type="hidden" id="tutorId" name="identificacionOriginal">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="identificacion" class="form-label">Número de Cédula *</label>
                                <input type="number" class="form-control" id="identificacion" name="identificacion" required>
                                <div class="invalid-feedback">
                                    Por favor ingrese un número de cédula válido.
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="rol" class="form-label">Rol *</label>
                                <select class="form-select" id="rol" name="rol" required>
                                    <option value="">Seleccionar rol</option>
                                    <option value="Tutor">Tutor</option>
                                    <option value="Administrador">Administrador</option>
                                </select>
                                <div class="invalid-feedback">
                                    Por favor seleccione un rol.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="nombre" class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="nombre" name="nombre" required>
                                <div class="invalid-feedback">
                                    Por favor ingrese el nombre.
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="apellidos" class="form-label">Apellidos *</label>
                                <input type="text" class="form-control" id="apellidos" name="apellidos" required>
                                <div class="invalid-feedback">
                                    Por favor ingrese los apellidos.
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarTutor()">
                    <i class="fas fa-save"></i>
                    Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Asignar Grupos -->
<div class="modal fade" id="modalAsignarGrupos" tabindex="-1" aria-labelledby="modalAsignarGruposLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAsignarGruposLabel">Asignar Grupos - <span id="tutorNombreModal"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Grupos Disponibles</h6>
                        <div class="grupos-disponibles" id="gruposDisponibles">
                            <!-- Se cargan dinámicamente -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Grupos Asignados</h6>
                        <div class="grupos-asignados-modal" id="gruposAsignados">
                            <!-- Se cargan dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="modalEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalEliminarLabel">
                    <i class="fas fa-exclamation-triangle"></i>
                    Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro que deseas eliminar este tutor?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i>
                    Esta acción quitará al tutor de todos los grupos asignados.
                </div>
                <div id="tutorInfo"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">
                    <i class="fas fa-trash"></i>
                    Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para importar profesores -->
<div class="modal fade" id="modalImportar" tabindex="-1" aria-labelledby="modalImportarLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalImportarLabel">
                    <i class="fas fa-file-excel text-success"></i>
                    Importar Profesores desde Excel
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Formato requerido del archivo Excel:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Columna A: <strong>Apellidos</strong></li>
                        <li>Columna B: <strong>Nombre</strong></li>
                        <li>Columna C: <strong>Cédula</strong> (solo números)</li>
                    </ul>
                    <small class="text-muted d-block mt-2">
                        Nota: Los profesores importados tendrán rol "Tutor" por defecto. Puede cambiar el rol después de la importación.
                    </small>
                </div>

                <form action="@Url.Action("ImportarProfesores", "Home")" method="post" enctype="multipart/form-data" id="formImportar">
                    <div class="form-group">
                        <label for="archivoExcel" class="form-label">Archivo Excel *</label>
                        <input type="file" class="form-control" id="archivoExcel" name="archivo" accept=".xlsx,.xls" required>
                        <div class="form-text">Solo se permiten archivos .xlsx y .xls (máximo 5MB)</div>
                        <div class="invalid-feedback">
                            Por favor seleccione un archivo Excel válido.
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-download text-primary"></i>
                                        Plantilla de ejemplo
                                    </h6>
                                    <p class="card-text small mb-2">Descargue una plantilla de ejemplo con el formato correcto:</p>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="descargarPlantilla()">
                                        <i class="fas fa-download"></i>
                                        Descargar Plantilla
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-check-circle text-success"></i>
                                        Validaciones
                                    </h6>
                                    <ul class="small mb-0">
                                        <li>Cédulas duplicadas serán omitidas</li>
                                        <li>Se validan todos los campos obligatorios</li>
                                        <li>Se reportan errores por fila</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnImportar" onclick="importarProfesores()" disabled>
                    <i class="fas fa-upload"></i>
                    Importar Excel
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="~/js/tutores.js"></script>
}
