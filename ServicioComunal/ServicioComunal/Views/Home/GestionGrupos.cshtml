@model IEnumerable<ServicioComunal.Models.Grupo>
@{
    ViewData["Title"] = "Gestión de Grupos";
    Layout = "_Layout";
}

<div class="dashboard-content">
    <div class="content-header">
        <div class="header-left">
            <h1>Gestión de Grupos</h1>
            <p>Administrar formación de grupos</p>
        </div>
        <div class="header-actions">
            <button type="button" class="btn btn-warning me-2" onclick="limpiarYReiniciarGrupos()" title="Limpiar y recrear todos los grupos con líderes">
                <i class="fas fa-broom"></i>
                Limpiar y Recrear
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalGrupo">
                <i class="fas fa-plus"></i>
                Crear Grupo
            </button>
        </div>
    </div>

    <!-- Filtros y búsqueda -->
    <div class="filters-section">
        <div class="filters-card">
            <div class="row">
                <div class="col-md-4">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Buscar por número de grupo..." class="form-control">
                    </div>
                </div>
                <div class="col-md-3">
                    <select id="filterEstado" class="form-select">
                        <option value="">Todos los estados</option>
                        <option value="con-estudiantes">Con estudiantes</option>
                        <option value="sin-estudiantes">Sin estudiantes</option>
                        <option value="con-tutor">Con tutor asignado</option>
                        <option value="sin-tutor">Sin tutor asignado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="filterTamaño" class="form-select">
                        <option value="">Cualquier tamaño</option>
                        <option value="pequeno">Pequeño (1-2 estudiantes)</option>
                        <option value="mediano">Mediano (3-4 estudiantes)</option>
                        <option value="grande">Grande (5+ estudiantes)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()">
                        <i class="fas fa-times"></i>
                        Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-icon groups">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
                <div class="stat-number" id="totalGrupos">@Model.Count()</div>
                <div class="stat-label">Total Grupos</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon students">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="stat-info">
                <div class="stat-number" id="conEstudiantes">@Model.Count(g => g.GruposEstudiantes.Any())</div>
                <div class="stat-label">Con Estudiantes</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="fas fa-crown"></i>
            </div>
            <div class="stat-info">
                <div class="stat-number" id="conLider">@Model.Count(g => g.LiderIdentificacion != null)</div>
                <div class="stat-label">Con Líder</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon tutors">
                <i class="fas fa-chalkboard-teacher"></i>
            </div>
            <div class="stat-info">
                <div class="stat-number" id="conTutor">@Model.Count(g => g.GruposProfesores.Any())</div>
                <div class="stat-label">Con Tutor</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-info">
                <div class="stat-number" id="sinTutor">@Model.Count(g => g.GruposEstudiantes.Any() && !g.GruposProfesores.Any())</div>
                <div class="stat-label">Sin Tutor</div>
            </div>
        </div>
    </div>

    <!-- Tabla de grupos -->
    <div class="table-section">
        <div class="table-card">
            <div class="table-header">
                <h3>Lista de Grupos</h3>
                <div class="table-actions">
                    <button type="button" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download"></i>
                        Exportar
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover" id="tablaGrupos">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Líder</th>
                            <th>Estudiantes</th>
                            <th>Tutor Asignado</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var grupo in Model)
                        {
                            var estudiantes = grupo.GruposEstudiantes.ToList();
                            var tutor = grupo.GruposProfesores.FirstOrDefault()?.Profesor;
                            var lider = grupo.Lider;
                            <tr data-grupo-id="@grupo.Numero">
                                <td>
                                    <div class="grupo-numero">
                                        <i class="fas fa-users"></i>
                                        Grupo @grupo.Numero
                                    </div>
                                </td>
                                <td>
                                    @if (lider != null)
                                    {
                                        <div class="lider-info">
                                            <i class="fas fa-crown text-warning"></i>
                                            <span>@lider.Nombre @lider.Apellidos</span>
                                            <small class="text-muted d-block">@lider.Clase</small>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="badge badge-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Sin líder
                                        </span>
                                    }
                                </td>
                                <td>
                                    <div class="estudiantes-info">
                                        <span class="estudiantes-count">@estudiantes.Count estudiantes</span>
                                        @if (estudiantes.Any())
                                        {
                                            <div class="estudiantes-list">
                                                @foreach (var ge in estudiantes.Take(3))
                                                {
                                                    var esLider = ge.EstudianteIdentificacion == grupo.LiderIdentificacion;
                                                    <span class="estudiante-tag @(esLider ? "lider" : "")">
                                                        @if (esLider) { <i class="fas fa-crown text-warning"></i> }
                                                        @ge.Estudiante.Nombre @ge.Estudiante.Apellidos
                                                    </span>
                                                }
                                                @if (estudiantes.Count > 3)
                                                {
                                                    <span class="estudiante-tag more">+@(estudiantes.Count - 3) más</span>
                                                }
                                            </div>
                                        }
                                    </div>
                                </td>
                                <td>
                                    @if (tutor != null)
                                    {
                                        <div class="tutor-info">
                                            <i class="fas fa-chalkboard-teacher text-success"></i>
                                            <span>@tutor.Nombre @tutor.Apellidos</span>
                                            <small class="text-muted d-block">@tutor.Rol</small>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="badge badge-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Sin asignar
                                        </span>
                                    }
                                </td>
                                <td>
                                    @if (!estudiantes.Any())
                                    {
                                        <span class="badge badge-secondary">
                                            <i class="fas fa-circle"></i>
                                            Vacío
                                        </span>
                                    }
                                    else if (tutor == null)
                                    {
                                        <span class="badge badge-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Pendiente Tutor
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-success">
                                            <i class="fas fa-check-circle"></i>
                                            Completo
                                        </span>
                                    }
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                onclick="verDetallesAvanzados(@grupo.Numero)" 
                                                title="Gestión avanzada">
                                            <i class="fas fa-users-cog"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" 
                                                onclick="gestionarEstudiantes(@grupo.Numero)" 
                                                title="Gestionar estudiantes">
                                            <i class="fas fa-user-plus"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="eliminarGrupo(@grupo.Numero)" 
                                                title="Eliminar grupo">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Crear Grupo -->
<div class="modal fade" id="modalGrupo" tabindex="-1" aria-labelledby="modalGrupoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalGrupoLabel">Crear Grupo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formGrupo" novalidate>
                    <div class="form-group">
                        <label for="numeroGrupo" class="form-label">Número de Grupo *</label>
                        <input type="number" class="form-control" id="numeroGrupo" name="numero" required min="1">
                        <div class="invalid-feedback">
                            Por favor ingrese un número de grupo válido.
                        </div>
                        <div class="form-text">
                            El número debe ser único y mayor a 0.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="crearGrupo()">
                    <i class="fas fa-save"></i>
                    Crear Grupo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Gestionar Estudiantes -->
<div class="modal fade" id="modalGestionarEstudiantes" tabindex="-1" aria-labelledby="modalGestionarEstudiantesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalGestionarEstudiantesLabel">
                    <i class="fas fa-users me-2"></i>
                    Gestionar Estudiantes - Grupo <span id="grupoNumeroModal"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-5">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0"><i class="fas fa-user-plus me-2"></i>Estudiantes Disponibles</h6>
                            <span class="badge bg-secondary" id="countDisponibles">0</span>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control form-control-sm" id="buscarDisponibles" 
                                   placeholder="Buscar estudiantes...">
                        </div>
                        <div class="border rounded p-2" style="min-height: 350px; max-height: 350px; overflow-y: auto;">
                            <div id="estudiantesDisponibles">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                    <div>Cargando estudiantes...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex flex-column justify-content-center align-items-center">
                        <button type="button" class="btn btn-primary btn-sm mb-2" id="moverTodosAGrupo" title="Mover todos al grupo">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                        <button type="button" class="btn btn-primary btn-sm mb-2" id="moverSeleccionadosAGrupo" title="Mover seleccionados al grupo">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm mb-2" id="moverSeleccionadosADisponibles" title="Quitar seleccionados del grupo">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="moverTodosADisponibles" title="Quitar todos del grupo">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                    </div>
                    <div class="col-md-5">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0"><i class="fas fa-users me-2"></i>Estudiantes del Grupo</h6>
                            <span class="badge bg-primary" id="countGrupo">0</span>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control form-control-sm" id="buscarGrupo" 
                                   placeholder="Buscar en el grupo...">
                        </div>
                        <div class="border rounded p-2" style="min-height: 350px; max-height: 350px; overflow-y: auto;">
                            <div id="estudiantesGrupo">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-users fa-2x mb-2"></i>
                                    <div>No hay estudiantes en este grupo</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-12">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Instrucciones:</strong> Selecciona estudiantes y usa los botones centrales para moverlos entre las listas, 
                            o haz doble clic en un estudiante para moverlo automáticamente.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="cerrarModalGestionEstudiantes()">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="guardarAsignaciones">
                    <i class="fas fa-save me-2"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="modalEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalEliminarLabel">
                    <i class="fas fa-exclamation-triangle"></i>
                    Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro que deseas eliminar este grupo?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i>
                    Esta acción eliminará el grupo y quitará todos los estudiantes asignados.
                </div>
                <div id="grupoInfo"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">
                    <i class="fas fa-trash"></i>
                    Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Gestión Avanzada de Grupo -->
<div class="modal fade" id="modalGestionAvanzada" tabindex="-1" aria-labelledby="modalGestionAvanzadaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalGestionAvanzadaLabel">
                    <i class="fas fa-users-cog"></i> Gestión Avanzada de Grupo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="contenidoGestionAvanzada">
                    <!-- El contenido se carga dinámicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-info" onclick="location.reload();">
                    <i class="fas fa-refresh"></i> Actualizar Página
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Limpiar y Recrear Grupos -->
<div class="modal fade" id="modalLimpiarGrupos" tabindex="-1" aria-labelledby="modalLimpiarGruposLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalLimpiarGruposLabel">
                    <i class="fas fa-exclamation-triangle"></i> Limpiar y Recrear Grupos
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>¡ATENCIÓN!</strong> Esta acción eliminará TODOS los datos existentes:
                </div>
                <ul>
                    <li>Todas las solicitudes</li>
                    <li>Todos los grupos existentes</li>
                    <li>Todas las relaciones grupo-estudiante</li>
                    <li>Todas las entregas</li>
                    <li>Todas las notificaciones</li>
                </ul>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Se crearán nuevos grupos automáticamente:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Grupos de máximo 4 estudiantes</li>
                        <li>El primer estudiante de cada grupo será el líder</li>
                        <li>Numeración secuencial de grupos</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmarLimpiezaGrupos()">
                    <i class="fas fa-broom"></i> Confirmar Limpieza
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/grupos.js"></script>
}
