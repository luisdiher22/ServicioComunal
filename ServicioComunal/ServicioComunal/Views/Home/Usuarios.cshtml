@model List<ServicioComunal.Models.Usuario>
@{
    ViewData["Title"] = "Gesti칩n de Usuarios";
    Layout = "_Layout";
}

<div class="dashboard-content">
    <div class="content-header">
        <h1>Gesti칩n de Usuarios</h1>
        <p>Administrar usuarios del sistema y sus contrase침as</p>
    </div>

    <!-- Estad칤sticas r치pidas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white stats-card-small">
                <div class="card-body text-center p-3">
                    <i class="fas fa-users fa-lg mb-1"></i>
                    <h6 class="mb-1">@Model.Count</h6>
                    <small>Total Usuarios</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark stats-card-small">
                <div class="card-body text-center p-3">
                    <i class="fas fa-exclamation-triangle fa-lg mb-1"></i>
                    <h6 class="mb-1">@Model.Count(u => u.RequiereCambioContrase침a)</h6>
                    <small>Requieren Cambio</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white stats-card-small">
                <div class="card-body text-center p-3">
                    <i class="fas fa-clock fa-lg mb-1"></i>
                    <h6 class="mb-1">@Model.Count(u => u.UltimoAcceso.HasValue && u.UltimoAcceso.Value > DateTime.Now.AddDays(-7))</h6>
                    <small>Activos esta semana</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Filtrar por rol:</label>
                    <select class="form-select" id="filtroRol" onchange="filtrarUsuarios()">
                        <option value="">Todos los roles</option>
                        <option value="Administrador">Administrador</option>
                        <option value="Tutor">Tutor</option>
                        <option value="Estudiante">Estudiante</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filtrar por estado:</label>
                    <select class="form-select" id="filtroEstado" onchange="filtrarUsuarios()">
                        <option value="">Todos los estados</option>
                        <option value="requiere-cambio">Requiere cambio contrase침a</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Buscar usuario:</label>
                    <input type="text" class="form-control" id="buscarUsuario" placeholder="Nombre de usuario o identificaci칩n" onkeyup="filtrarUsuarios()">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="limpiarFiltrosUsuarios()">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de usuarios -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-list"></i> Lista de Usuarios
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="tablaUsuarios">
                    <thead class="table-dark">
                        <tr>
                            <th>Identificaci칩n</th>
                            <th>Usuario</th>
                            <th>Estado Contrase침a</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>칔ltimo Acceso</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var usuario in Model)
                        {
                            <tr class="usuario-row" data-rol="@usuario.Rol" data-estado="@(usuario.Activo ? "activo" : "inactivo")" data-requiere-cambio="@usuario.RequiereCambioContrase침a">
                                <td>
                                    <strong>@usuario.Identificacion</strong>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas @(usuario.Rol == "Administrador" ? "fa-user-shield" : usuario.Rol == "Tutor" ? "fa-chalkboard-teacher" : "fa-graduation-cap") me-2 text-@(usuario.Rol == "Administrador" ? "danger" : usuario.Rol == "Tutor" ? "warning" : "primary")"></i>
                                        @usuario.NombreUsuario
                                    </div>
                                </td>
                                <td>
                                    <div class="password-status">
                                        @if (usuario.RequiereCambioContrase침a)
                                        {
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-exclamation-triangle"></i> Temporal (c칠dula)
                                            </span>
                                            <br><small class="text-muted">Debe cambiar en pr칩ximo login</small>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle"></i> Personalizada
                                            </span>
                                            <br><small class="text-muted">Usuario defini칩 su contrase침a</small>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-@(usuario.Rol == "Administrador" ? "danger" : usuario.Rol == "Tutor" ? "warning" : "primary")">
                                        @usuario.Rol
                                    </span>
                                </td>
                                <td>
                                    @if (usuario.Activo)
                                    {
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Activo
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-times"></i> Inactivo
                                        </span>
                                    }
                                </td>
                                <td>
                                    @if (usuario.UltimoAcceso.HasValue)
                                    {
                                        <span class="text-muted">@usuario.UltimoAcceso.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Nunca</span>
                                    }
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="abrirModalCambiarContrase침a(@usuario.Identificacion, '@usuario.NombreUsuario')" title="Cambiar contrase침a">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="restablecerContrase침a(@usuario.Identificacion, '@usuario.NombreUsuario')" title="Restablecer contrase침a a c칠dula">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para cambiar contrase침a -->
<div class="modal fade" id="modalCambiarContrase침a" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-key"></i> Cambiar Contrase침a
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCambiarContrase침a">
                    <input type="hidden" id="usuarioId">
                    <div class="mb-3">
                        <label class="form-label">Usuario:</label>
                        <input type="text" class="form-control" id="usuarioNombre" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nueva Contrase침a:</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="nuevaContrase침a" placeholder="M칤nimo 8 caracteres">
                            <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordField('nuevaContrase침a')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <small>La contrase침a debe tener al menos 8 caracteres y contener al menos un n칰mero.</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirmar Contrase침a:</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirmarContrase침a" placeholder="Confirma la nueva contrase침a">
                            <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordField('confirmarContrase침a')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="forzarCambio" checked>
                        <label class="form-check-label" for="forzarCambio">
                            Forzar cambio de contrase침a en el pr칩ximo acceso
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarNuevaContrase침a()">
                    <i class="fas fa-save"></i> Cambiar Contrase침a
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function togglePasswordField(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = field.nextElementSibling.querySelector('i');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function filtrarUsuarios() {
            const filtroRol = document.getElementById('filtroRol').value;
            const filtroEstado = document.getElementById('filtroEstado').value;
            const busqueda = document.getElementById('buscarUsuario').value.toLowerCase();
            
            const filas = document.querySelectorAll('.usuario-row');
            
            filas.forEach(fila => {
                const rol = fila.getAttribute('data-rol');
                const estado = fila.getAttribute('data-estado');
                const requiereCambio = fila.getAttribute('data-requiere-cambio') === 'True';
                const textoFila = fila.textContent.toLowerCase();
                
                let mostrar = true;
                
                // Filtro por rol
                if (filtroRol && rol !== filtroRol) {
                    mostrar = false;
                }
                
                // Filtro por estado
                if (filtroEstado) {
                    if (filtroEstado === 'activo' && estado !== 'activo') mostrar = false;
                    if (filtroEstado === 'inactivo' && estado !== 'inactivo') mostrar = false;
                    if (filtroEstado === 'requiere-cambio' && !requiereCambio) mostrar = false;
                }
                
                // Filtro por b칰squeda
                if (busqueda && !textoFila.includes(busqueda)) {
                    mostrar = false;
                }
                
                fila.style.display = mostrar ? '' : 'none';
            });
        }

        function limpiarFiltrosUsuarios() {
            document.getElementById('filtroRol').value = '';
            document.getElementById('filtroEstado').value = '';
            document.getElementById('buscarUsuario').value = '';
            filtrarUsuarios();
        }

        function guardarNuevaContrase침a() {
            const usuarioId = document.getElementById('usuarioId').value;
            const nuevaContrase침a = document.getElementById('nuevaContrase침a').value;
            const confirmarContrase침a = document.getElementById('confirmarContrase침a').value;
            const forzarCambio = document.getElementById('forzarCambio').checked;

            // Validaciones
            if (!nuevaContrase침a || nuevaContrase침a.length < 8) {
                mostrarError('La contrase침a debe tener al menos 8 caracteres.');
                return;
            }

            if (!/\d/.test(nuevaContrase침a)) {
                mostrarError('La contrase침a debe contener al menos un n칰mero.');
                return;
            }

            if (nuevaContrase침a !== confirmarContrase침a) {
                mostrarError('Las contrase침as no coinciden.');
                return;
            }

            // Enviar datos al servidor
            fetch('@Url.Action("CambiarContrase침aUsuario", "Home")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify({
                    usuarioId: usuarioId,
                    nuevaContrase침a: nuevaContrase침a,
                    forzarCambio: forzarCambio
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Cerrar el modal primero
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalCambiarContrase침a'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Mostrar SweetAlert y recargar al confirmar
                    Swal.fire({
                        title: '춰칄xito!',
                        text: 'Contrase침a cambiada exitosamente.',
                        icon: 'success',
                        confirmButtonText: 'Aceptar'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    mostrarError('Error al cambiar contrase침a: ' + data.message);
                }
            })
            .catch(error => {
                mostrarError('Error de conexi칩n: ' + error.message);
            });
        }



        function restablecerContrase침a(usuarioId, nombreUsuario) {
            Swal.fire({
                title: '游댐 Restablecer Contrase침a',
                html: `
                    <div class="text-start">
                        <p><strong>Restablecer la contrase침a de "${nombreUsuario}" a su c칠dula?</strong></p>
                        <hr>
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle"></i> El usuario deber치 cambiar la contrase침a en el pr칩ximo inicio de sesi칩n.
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-key"></i> S칤, restablecer',
                cancelButtonText: '<i class="fas fa-times"></i> Cancelar'
            }).then((result) => {
                if (!result.isConfirmed) {
                    return;
                }

                // Mostrar spinner mientras se procesa
                Swal.fire({
                    title: 'Restableciendo contrase침a...',
                    html: 'Por favor espera',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                fetch('@Url.Action("RestablecerContrase침a", "Home")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usuarioId: usuarioId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: '춰칄xito!',
                            text: data.message,
                            icon: 'success',
                            confirmButtonText: 'Aceptar',
                            confirmButtonColor: '#28a745'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: 'Error al restablecer contrase침a: ' + data.message,
                            icon: 'error',
                            confirmButtonText: 'Aceptar',
                            confirmButtonColor: '#dc3545'
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        title: 'Error de conexi칩n',
                        text: 'No se pudo conectar con el servidor: ' + error.message,
                        icon: 'error',
                        confirmButtonText: 'Aceptar',
                        confirmButtonColor: '#dc3545'
                    });
                });
            });
        }

        function abrirModalCambiarContrase침a(usuarioId, nombreUsuario) {
            document.getElementById('usuarioId').value = usuarioId;
            document.getElementById('usuarioNombre').value = nombreUsuario;
            document.getElementById('nuevaContrase침a').value = '';
            document.getElementById('confirmarContrase침a').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('modalCambiarContrase침a'));
            modal.show();
        }

        function marcarCambioRealizado(usuarioId) {
            if (confirm('쯄arcar que este usuario ya cambi칩 su contrase침a?')) {
                fetch('@Url.Action("MarcarCambioContrase침aRealizado", "Home")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usuarioId: usuarioId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
            }
        }
    </script>
}

<style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .stats-card-small .card-body {
        padding: 0.75rem !important;
    }
    
    .stats-card-small i {
        font-size: 1.25rem;
    }
    
    .stats-card-small h6 {
        font-size: 1.1rem;
        font-weight: bold;
        margin: 0.25rem 0;
    }
    
    .stats-card-small small {
        font-size: 0.75rem;
        opacity: 0.9;
    }
    
    .usuario-row:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .badge {
        font-size: 0.75em;
    }
    
    .btn-group {
        gap: 2px;
    }
</style>
