@{
    ViewData["Title"] = "Cambiar Contraseña";
    ViewData["IsLogin"] = true;
    Layout = "_Layout";
}

<div class="login-container">
    <!-- Elementos flotantes decorativos -->
    <div class="floating-elements">
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
    </div>

    <div class="login-card">
        <!-- Logo -->
        <div class="logo-container">
            <img src="~/images/logo.png" alt="Logo Liceo Carrillos de Poás" class="logo" />
        </div>

        <!-- Título -->
        <h1 class="login-title">Cambio de Contraseña Obligatorio</h1>
        <p class="login-subtitle">
            Hola <strong>@ViewBag.NombreUsuario</strong><br>
            Por seguridad, debes establecer una nueva contraseña antes de continuar.
        </p>

        <!-- Mensajes de error/éxito -->
        @if (!string.IsNullOrEmpty(ViewBag.Error as string))
        {
            <div class="alert alert-danger" id="errorAlert">
                <i class="fas fa-exclamation-triangle"></i>
                @ViewBag.Error
            </div>
        }

        @if (!string.IsNullOrEmpty(ViewBag.Success as string))
        {
            <div class="alert alert-success" id="successAlert">
                <i class="fas fa-check-circle"></i>
                @ViewBag.Success
                <br><small>Serás redirigido automáticamente...</small>
            </div>
        }

        <!-- Formulario de Cambio de Contraseña -->
        <form method="post" id="cambiarContraseñaForm" novalidate>
            <!-- Contraseña Actual -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-lock"></i>
                    Contraseña Actual
                </label>
                <div class="input-group">
                    <input type="password" 
                           name="contraseñaActual" 
                           id="contraseñaActual"
                           class="form-control" 
                           placeholder="Ingresa tu contraseña actual (tu cédula)" 
                           required>
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('contraseñaActual', 'togglePasswordActual')">
                            <i class="fas fa-eye" id="togglePasswordActual"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Nueva Contraseña -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-key"></i>
                    Nueva Contraseña
                </label>
                <div class="input-group">
                    <input type="password" 
                           name="nuevaContraseña" 
                           class="form-control" 
                           placeholder="Mínimo 8 caracteres con al menos 1 número" 
                           required
                           id="nuevaContraseña">
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('nuevaContraseña', 'togglePasswordNueva')">
                            <i class="fas fa-eye" id="togglePasswordNueva"></i>
                        </button>
                    </div>
                </div>
                <small class="form-text text-muted">
                    <i class="fas fa-info-circle"></i>
                    Debe tener al menos 8 caracteres y contener al menos un número
                </small>
            </div>

            <!-- Confirmar Nueva Contraseña -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-key"></i>
                    Confirmar Nueva Contraseña
                </label>
                <div class="input-group">
                    <input type="password" 
                           name="confirmarContraseña" 
                           class="form-control" 
                           placeholder="Confirma tu nueva contraseña" 
                           required
                           id="confirmarContraseña">
                    <div class="input-group-append">
                        <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('confirmarContraseña', 'togglePasswordConfirmar')">
                            <i class="fas fa-eye" id="togglePasswordConfirmar"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Botón de cambiar contraseña -->
            <button type="submit" class="btn-login" id="cambiarBtn">
                <span>Cambiar Contraseña</span>
            </button>
        </form>

        <!-- Sección de requisitos -->
        <div class="help-section">
            <div class="help-title">
                <i class="fas fa-shield-alt"></i>
                Requisitos de Seguridad
            </div>
            <ul class="requirements-list">
                <li id="req-length">
                    <i class="fas fa-circle requirement-icon"></i>
                    Al menos 8 caracteres
                </li>
                <li id="req-number">
                    <i class="fas fa-circle requirement-icon"></i>
                    Al menos un número (0-9)
                </li>
                <li id="req-match">
                    <i class="fas fa-circle requirement-icon"></i>
                    Las contraseñas deben coincidir
                </li>
            </ul>
        </div>
    </div>
</div>

<style>
    .requirements-list {
        list-style: none;
        padding: 0;
        margin: 10px 0;
    }
    
    .requirements-list li {
        padding: 5px 0;
        color: #666;
        font-size: 0.9em;
    }
    
    .requirement-icon {
        font-size: 0.7em;
        margin-right: 8px;
        color: #dc3545;
    }
    
    .requirement-valid .requirement-icon {
        color: #28a745;
    }
    
    .form-text {
        margin-top: 5px;
    }
    
    .alert {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: none;
        animation: slideIn 0.3s ease-out;
    }
    
    .alert-danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);
        color: white;
    }
    
    .alert-success {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
    }
    
    /* Animación de entrada */
    .alert {
        animation: slideIn 0.3s ease-out;
    }
    
    /* Se define la animación en site.css */
</style>
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('cambiarContraseñaForm');
        const nuevaContraseña = document.getElementById('nuevaContraseña');
        const confirmarContraseña = document.getElementById('confirmarContraseña');
        const cambiarBtn = document.getElementById('cambiarBtn');
        
        // Elementos de requisitos
        const reqLength = document.getElementById('req-length');
        const reqNumber = document.getElementById('req-number');
        const reqMatch = document.getElementById('req-match');
        
        // Validación en tiempo real
        function validarContraseña() {
            const valor = nuevaContraseña.value;
            
            // Validar longitud
            if (valor.length >= 8) {
                reqLength.classList.add('requirement-valid');
            } else {
                reqLength.classList.remove('requirement-valid');
            }
            
            // Validar número
            if (/\d/.test(valor)) {
                reqNumber.classList.add('requirement-valid');
            } else {
                reqNumber.classList.remove('requirement-valid');
            }
            
            validarCoincidencia();
        }
        
        function validarCoincidencia() {
            if (confirmarContraseña.value && nuevaContraseña.value === confirmarContraseña.value) {
                reqMatch.classList.add('requirement-valid');
            } else {
                reqMatch.classList.remove('requirement-valid');
            }
        }
        
        nuevaContraseña.addEventListener('input', validarContraseña);
        confirmarContraseña.addEventListener('input', validarCoincidencia);
        
        // Efecto visual en inputs
        const inputs = form.querySelectorAll('.form-control');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.querySelector('.form-label').style.color = '#6c8d47';
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.querySelector('.form-label').style.color = '';
            });
        });
        
        // Auto-hide de alertas
        const errorAlert = document.getElementById('errorAlert');
        if (errorAlert) {
            setTimeout(() => {
                errorAlert.style.opacity = '0';
                errorAlert.style.transform = 'translateX(-20px)';
                setTimeout(() => {
                    errorAlert.style.display = 'none';
                }, 300);
            }, 5000);
        }
        
        // Auto-redirect en caso de éxito
        const successAlert = document.getElementById('successAlert');
        if (successAlert) {
            setTimeout(() => {
                window.location.href = '@Url.Action("Dashboard", "Home")';
            }, 3000);
        }
    });
</script>
